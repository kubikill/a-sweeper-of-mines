"use strict";!function(){function e(e){return document.getElementById(e)}const t={nav:{menuBtn:e("menu-btn"),settingsBtn:e("settings-btn"),newGameBtn:e("newgame-btn"),mineCounter:document.querySelector("#mine-counter > span"),timer:{minutes:e("timer-minutes"),seconds:e("timer-seconds")},hintBtn:e("hint-btn"),mineBtn:e("mine-btn"),markBtn:e("mark-btn")},playarea:{columnNums:e("column-nums"),rowNums:e("row-nums"),board:{tiles:null,container:e("board")},winOverlay:{container:e("win-overlay"),time:e("win-time"),newBestTime:e("new-best-time"),newGameBtn:e("win-new-game-btn"),viewBoardBtn:e("win-view-board-btn")},loseOverlay:{container:e("lose-overlay"),minesLeft:e("lose-mines-left"),newGameBtn:e("lose-new-game-btn"),viewBoardBtn:e("lose-view-board-btn")}},modals:{container:e("modals"),menu:{container:e("menu-modal"),btns:e("menu-modal-btns")},settings:{container:e("settings-modal"),boardSize:e("settings-boardSize"),customBoard:{container:e("settings-customBoard"),rows:e("settings-boardHeight"),columns:e("settings-boardWidth"),numOfMines:e("settings-mineNum"),maxMines:e("settings-maxMines")},boardApplyWarning:e("settings-applywarning"),tileSize:e("settings-tileSize"),theme:e("settings-theme")},statistics:{select:e("stats-select"),gamesPlayed:e("stats-gamesplayed"),gamesWon:e("stats-gameswon"),gamesLost:e("stats-gameslost"),winPercent:e("stats-winpercent"),bestTime:e("stats-besttime"),longestWinningStreak:e("stats-longestwinstreak"),longestLosingStreak:e("stats-longestlosestreak"),currentStreak:e("stats-currentstreak")},newGameWarning:{container:e("newgamewarning-modal"),confirm:e("newgamewarning-confirm")}}};let a=[];class n{uncovered=!1;hasMine=!1;numOfNearbyMines=0;markedAsEmpty=!1}const s={state:"initial",minesLeft:20,hints:1,hintMode:!1,markMode:"none",clickSwap:!1,timeStart:null,board:{rows:10,columns:10,numOfMines:20},boardSize:"small",rowMineCount:[],columnMineCount:[]};let r={board:{rows:10,columns:10,numOfMines:20},boardSize:"small",maxMines:50,tileSize:32,theme:"auto"};const i={small:{rows:10,columns:10,numOfMines:20},medium:{rows:15,columns:15,numOfMines:50},large:{rows:20,columns:20,numOfMines:90},veryLarge:{rows:30,columns:30,numOfMines:200}};let o,l={small:{gamesWon:0,gamesLost:0,bestTime:null,longestWinningStreak:0,longestLosingStreak:0,currentStreak:0,streakMode:"N/A"},medium:{gamesWon:0,gamesLost:0,bestTime:null,longestWinningStreak:0,longestLosingStreak:0,currentStreak:0,streakMode:"N/A"},large:{gamesWon:0,gamesLost:0,bestTime:null,longestWinningStreak:0,longestLosingStreak:0,currentStreak:0,streakMode:"N/A"},veryLarge:{gamesWon:0,gamesLost:0,bestTime:null,longestWinningStreak:0,longestLosingStreak:0,currentStreak:0,streakMode:"N/A"},custom:{gamesWon:0,gamesLost:0,longestWinningStreak:0,longestLosingStreak:0,currentStreak:0,streakMode:"N/A"}};function d(e,t){return e<0||e>=s.board.rows||t<0||t>=s.board.columns||!a[e][t].hasMine?0:1}function m(e,t){let n=0;for(let a=-1;a<=1;a++)for(let s=-1;s<=1;s++)0==a&&0==s||(n+=d(e+a,t+s));a[e][t].numOfNearbyMines=n}function c(e,a){return t.playarea.board.container.querySelector(`[data-row="${e}"][data-column="${a}"]`)}function u(e,n){"initial"==s.state?(s.state="underway",function(e,t,n){let r=[];for(let e=0;e<s.board.rows;e++)for(let t=0;t<s.board.columns;t++)r.push({row:e,column:t});s.rowMineCount=new Array(s.board.rows).fill(0),s.columnMineCount=new Array(s.board.columns).fill(0);let i=r.findIndex((a=>a.row==e&&a.column==t));-1!=i&&r.splice(i,1),a[e][t].hasMine=!0;for(let e=1;e<n;e++){let e=Math.floor(Math.random()*r.length);a[r[e].row][r[e].column].hasMine=!0,r.splice(e,1)}for(let e=0;e<a.length;e++)for(let t=0;t<a[e].length;t++)m(parseInt(e),parseInt(t)),a[e][t].hasMine&&(s.rowMineCount[e]++,s.columnMineCount[t]++)}(e,n,s.board.numOfMines),function(){let e="";for(let t of s.rowMineCount)e+=`<div>${t}</div>`;t.playarea.rowNums.innerHTML=e,e="";for(let t of s.columnMineCount)e+=`<div>${t}</div>`;t.playarea.columnNums.innerHTML=e}(),o=setInterval((()=>{let e=Date.now()-s.timeStart,a=Math.floor(e/1e3),n=Math.floor(a/60),r=a%60;t.nav.timer.minutes.innerHTML=n<=9?`0${n}`:n,t.nav.timer.seconds.innerHTML=r<=9?`0${r}`:r}),200),s.timeStart=Date.now(),v(e,n),t.nav.mineCounter.innerHTML=s.minesLeft,s.xyzzyActivated&&T()):"underway"==s.state&&(1==s.hintMode?(v(e,n,!0),s.hints-=1,t.nav.hintBtn.dataset.hints=s.hints,s.hints<=0&&(t.nav.hintBtn.classList.remove("hint-active"),t.nav.hintBtn.classList.add("hint-disabled"),s.hintMode=!1)):v(e,n),t.nav.mineCounter.innerHTML=s.minesLeft)}function g(e,t){"underway"!=s.state||a[e][t].uncovered||(a[e][t].markedAsEmpty?("none"==s.markMode&&(s.markMode="remove"),"remove"==s.markMode&&(a[e][t].markedAsEmpty=!1,c(e,t).innerHTML="")):("none"==s.markMode&&(s.markMode="mark"),"mark"==s.markMode&&(a[e][t].markedAsEmpty=!0,c(e,t).innerHTML='<i class="icon-flag"></i>')))}function v(e,n,r=!1,i=!1){if("underway"!=s.state&&!i||e<0||e>=s.board.rows||n<0||n>=s.board.columns||a[e][n].uncovered)return null;if(a[e][n].hasMine&&!a[e][n].markedAsEmpty){c(e,n).innerHTML="<i class='icon-mine'></i>",c(e,n).dataset.clickable="false",a[e][n].uncovered=!0;for(let t=-1;t<=1;t++)for(let a=-1;a<=1;a++)0==t&&0==a||v(e+t,n+a,!0,i);s.minesLeft--,0==s.minesLeft&&"underway"==s.state&&function(){let e=Date.now()-s.timeStart,a=Math.floor(e/1e3),n=Math.floor(a/60),r=a%60,i=e%1e3;n<=9&&(n=`0${n}`);r<=9&&(r=`0${r}`);i<=100&&(i=`${"0".repeat(3-i.toString().length)}${i}`);t.playarea.winOverlay.time.innerHTML=`${n}:${r}.${i}`,l[s.boardSize].gamesWon++,"winning"!=l[s.boardSize].streakMode?(l[s.boardSize].currentStreak=1,l[s.boardSize].streakMode="winning"):l[s.boardSize].currentStreak++;l[s.boardSize].currentStreak>l[s.boardSize].longestWinningStreak&&(l[s.boardSize].longestWinningStreak=l[s.boardSize].currentStreak);e<=l[s.boardSize].bestTime||null===l[s.boardSize].bestTime?(l[s.boardSize].bestTime=e,t.playarea.winOverlay.newBestTime.style.display="block"):t.playarea.winOverlay.newBestTime.style.display="NONE";localStorage.setItem("sweeperofmines-statistics",JSON.stringify(l)),t.playarea.winOverlay.container.classList.remove("fade"),t.playarea.winOverlay.container.classList.add("visible"),t.playarea.board.container.classList.add("no-input"),s.state="finished",clearInterval(o)}()}else r?(a[e][n].uncovered=!0,a[e][n].markedAsEmpty=!1,c(e,n).innerHTML=a[e][n].numOfNearbyMines,c(e,n).dataset.clickable="false"):a[e][n].markedAsEmpty||"underway"!=s.state||(c(e,n).classList.add("wrong-tile"),function(){l[s.boardSize].gamesLost++,"losing"!=l[s.boardSize].streakMode?(l[s.boardSize].currentStreak=1,l[s.boardSize].streakMode="losing"):l[s.boardSize].currentStreak++;l[s.boardSize].currentStreak>l[s.boardSize].longestLosingStreak&&(l[s.boardSize].longestLosingStreak=l[s.boardSize].currentStreak);localStorage.setItem("sweeperofmines-statistics",JSON.stringify(l)),t.playarea.loseOverlay.minesLeft.innerHTML=s.minesLeft,t.playarea.loseOverlay.container.classList.remove("fade"),t.playarea.loseOverlay.container.classList.add("visible"),t.playarea.board.container.classList.add("no-input"),s.state="finished",clearInterval(o)}())}function b(e){if(t.modals.statistics.gamesPlayed.innerHTML=l[e].gamesWon+l[e].gamesLost,t.modals.statistics.gamesWon.innerHTML=l[e].gamesWon,t.modals.statistics.gamesLost.innerHTML=l[e].gamesLost,l[e].gamesWon+l[e].gamesLost!=0){let a=l[e].gamesWon/(l[e].gamesWon+l[e].gamesLost)*100;t.modals.statistics.winPercent.innerHTML=`${a.toFixed(2)}%`}else t.modals.statistics.winPercent.innerHTML="N/A";if(t.modals.statistics.longestWinningStreak.innerHTML=l[e].longestWinningStreak,t.modals.statistics.longestLosingStreak.innerHTML=l[e].longestLosingStreak,t.modals.statistics.currentStreak.innerHTML=`${l[e].currentStreak} (${l[e].streakMode})`,"custom"!=e){if(null!=l[e].bestTime){let a=Math.floor(l[e].bestTime/1e3/60),n=Math.floor(l[e].bestTime/1e3%60),s=l[e].bestTime%1e3;t.modals.statistics.bestTime.innerHTML=`${a}:${n}.${s}`}else t.modals.statistics.bestTime.innerHTML="N/A";t.modals.statistics.bestTime.parentNode.style.removeProperty("display")}else t.modals.statistics.bestTime.parentNode.style.display="none"}let y=!1,p=!1;function L(){s.boardSize=r.boardSize,"custom"!=r.boardSize?Object.assign(s.board,i[s.boardSize]):Object.assign(s.board,r.board),t.modals.settings.boardApplyWarning.style.removeProperty("display"),s.hints=1+Math.floor(s.board.columns*s.board.rows/400),s.hintMode=!1,t.nav.hintBtn.dataset.hints=s.hints,t.nav.hintBtn.classList.remove("hint-active"),t.nav.hintBtn.classList.remove("hint-disabled"),function(){a=[];for(let e=0;e<s.board.rows;e++){a[e]=[];for(let t=0;t<s.board.columns;t++)a[e][t]=new n}}(),function(){let e="";for(let t=0;t<a.length;t++){e+="<div>";for(let n=0;n<a[t].length;n++)e+=`<div data-row="${t}" data-column="${n}"></div>`;e+="</div>"}t.playarea.board.container.innerHTML=e,t.playarea.board.tiles=document.querySelectorAll("[data-row][data-column]");for(let e of t.playarea.board.tiles)e.addEventListener("pointerdown",(t=>{t.isPrimary&&!y?((2==t.button||s.clickSwap)&&(p=!0,g(parseInt(e.dataset.row),parseInt(e.dataset.column))),t.target.releasePointerCapture(t.pointerId)):y=!0})),e.addEventListener("pointerup",(t=>{t.isPrimary&&(t.isPrimary&&y?y=!1:(p=!1,s.clickSwap||0!=t.button||u(parseInt(e.dataset.row),parseInt(e.dataset.column))))})),e.addEventListener("contextmenu",(e=>(e.preventDefault(),!1))),e.addEventListener("pointerenter",(t=>{t.isPrimary&&(p||2==t.buttons)&&g(parseInt(e.dataset.row),parseInt(e.dataset.column))})),e.addEventListener("pointercancel",(e=>{p=!1,s.markMode="none"}))}(),function(){let e="";for(let t=0;t<s.board.rows;t++)e+="<div>#</div>";t.playarea.rowNums.innerHTML=e,e="";for(let t=0;t<s.board.columns;t++)e+="<div>#</div>";t.playarea.columnNums.innerHTML=e}(),s.state="initial",clearInterval(o),t.nav.timer.minutes.innerHTML=t.nav.timer.seconds.innerHTML="00",t.playarea.board.container.classList.remove("no-input"),t.nav.mineCounter.innerHTML=s.minesLeft=s.board.numOfMines}document.body.addEventListener("pointerup",(()=>{p=!1,s.markMode="none"})),t.nav.mineBtn.addEventListener("click",(()=>{s.clickSwap=!1,t.playarea.board.container.classList.remove("no-scroll"),t.nav.mineBtn.classList.add("active"),t.nav.markBtn.classList.remove("active")})),t.nav.markBtn.addEventListener("click",(()=>{s.clickSwap=!0,t.playarea.board.container.classList.add("no-scroll"),t.nav.markBtn.classList.add("active"),t.nav.mineBtn.classList.remove("active")})),t.nav.newGameBtn.addEventListener("click",(e=>{"underway"===s.state?(t.modals.container.classList.add("visible"),t.modals.container.classList.remove("fade"),t.modals.newGameWarning.container.classList.add("visible"),t.modals.newGameWarning.container.classList.remove("fade")):L()})),t.modals.newGameWarning.confirm.addEventListener("click",(e=>{l[s.boardSize].gamesLost++,"losing"!=l[s.boardSize].streakMode?(l[s.boardSize].currentStreak=1,l[s.boardSize].streakMode="losing"):l[s.boardSize].currentStreak++,l[s.boardSize].currentStreak>l[s.boardSize].longestLosingStreak&&(l[s.boardSize].longestLosingStreak=l[s.boardSize].currentStreak),localStorage.setItem("sweeperofmines-statistics",JSON.stringify(l)),L()})),t.nav.hintBtn.addEventListener("click",(()=>{s.hints>=1&&(t.nav.hintBtn.classList.toggle("hint-active"),s.hintMode=!s.hintMode)})),document.querySelectorAll("[data-modalopen]").forEach((e=>{e.addEventListener("click",(()=>{t.modals.container.classList.add("visible"),t.modals.container.classList.remove("fade"),document.querySelector(e.dataset.modalopen).classList.add("visible"),document.querySelector(e.dataset.modalopen).classList.remove("fade")}))})),document.querySelectorAll(".modal-close").forEach((e=>{e.addEventListener("click",(()=>{t.modals.container.classList.add("fade"),t.modals.container.classList.remove("visible"),e.parentNode.parentNode.classList.add("fade"),e.parentNode.parentNode.classList.remove("visible")}))})),document.querySelectorAll('[data-modalopen="#statistics-modal"]').forEach((e=>{e.addEventListener("click",(()=>{b(t.modals.statistics.select.value)}))})),t.modals.settings.container.addEventListener("click",(()=>{localStorage.setItem("sweeperofmines-settings",JSON.stringify(r)),"underway"!=s.state&&L()})),t.modals.settings.container.querySelector(".modal-close").addEventListener("click",(()=>{localStorage.setItem("sweeperofmines-settings",JSON.stringify(r)),"underway"!=s.state&&L()})),document.querySelectorAll(".modal").forEach((e=>{e.addEventListener("click",(a=>{a.target===a.currentTarget&&(t.modals.settings.container.classList.contains("visible")&&localStorage.setItem("sweeperofmines-settings",JSON.stringify(r)),t.modals.container.classList.add("fade"),t.modals.container.classList.remove("visible"),e.classList.add("fade"),e.classList.remove("visible"))}))})),t.modals.settings.container.addEventListener("click",(()=>{"underway"!=s.state&&L()})),t.modals.menu.btns.querySelectorAll("button").forEach((e=>{e.addEventListener("click",(()=>{t.modals.menu.container.classList.add("fade"),t.modals.menu.container.classList.remove("visible")}))})),t.playarea.board.container.addEventListener("scroll",(()=>{t.playarea.rowNums.scroll(0,t.playarea.board.container.scrollTop),t.playarea.columnNums.scroll(t.playarea.board.container.scrollLeft,0)}),{passive:!0}),t.playarea.winOverlay.newGameBtn.addEventListener("click",(()=>{L(),t.playarea.winOverlay.container.classList.add("fade"),t.playarea.winOverlay.container.classList.remove("visible")})),t.playarea.winOverlay.viewBoardBtn.addEventListener("click",(()=>{t.playarea.winOverlay.container.classList.add("fade"),t.playarea.winOverlay.container.classList.remove("visible")})),t.playarea.loseOverlay.newGameBtn.addEventListener("click",(()=>{L(),t.playarea.loseOverlay.container.classList.add("fade"),t.playarea.loseOverlay.container.classList.remove("visible")})),t.playarea.loseOverlay.viewBoardBtn.addEventListener("click",(()=>{t.playarea.loseOverlay.container.classList.add("fade"),t.playarea.loseOverlay.container.classList.remove("visible"),function(){for(let e=0;e<a.length;e++)for(let t=0;t<a[e].length;t++)a[e][t].hasMine?(c(e,t).innerHTML="<i class='icon-mine'></i>",c(e,t).dataset.clickable="false"):c(e,t).innerHTML=a[e][t].numOfNearbyMines}()})),t.modals.settings.boardSize.addEventListener("change",(e=>{r.boardSize=e.target.value,"underway"==s.state&&(t.modals.settings.boardApplyWarning.style.display="block")}));const f=/^[0-9]+$/g;function w(){let e=Math.floor(r.board.columns*r.board.rows/2);e<12&&(e=12),t.modals.settings.customBoard.maxMines.innerHTML=r.maxMines=e,t.modals.settings.customBoard.numOfMines.value>r.maxMines&&(t.modals.settings.customBoard.numOfMines.value=r.maxMines),r.board.numOfMines=parseInt(t.modals.settings.customBoard.numOfMines.value)}t.modals.settings.customBoard.columns.addEventListener("input",(e=>{e.target.value=e.target.value.match(f),e.target.value?e.target.value>100&&!z?(e.target.value=100,r.board.columns=parseInt(e.target.value)):r.board.columns=parseInt(e.target.value):r.board.columns=5,w(),"underway"==s.state&&(t.modals.settings.boardApplyWarning.style.display="block")})),t.modals.settings.customBoard.columns.addEventListener("blur",(e=>{!e.target.value||e.target.value<5?e.target.value=5:e.target.value>100&&!z&&(e.target.value=100),r.board.columns=parseInt(e.target.value),w(),"underway"==s.state&&(t.modals.settings.boardApplyWarning.style.display="block")})),t.modals.settings.customBoard.rows.addEventListener("input",(e=>{e.target.value=e.target.value.match(f),""==e.target.value?r.board.rows=5:e.target.value>100&&!z?(e.target.value=100,r.board.rows=parseInt(e.target.value)):r.board.rows=parseInt(e.target.value),w(),"underway"==s.state&&(t.modals.settings.boardApplyWarning.style.display="block")})),t.modals.settings.customBoard.rows.addEventListener("blur",(e=>{""==e.target.value||e.target.value<5?e.target.value=5:e.target.value>100&&!z&&(e.target.value=100),r.board.rows=parseInt(e.target.value),w(),"underway"==s.state&&(t.modals.settings.boardApplyWarning.style.display="block")})),t.modals.settings.customBoard.numOfMines.addEventListener("input",(e=>{e.target.value>r.maxMines&&(e.target.value=r.maxMines),r.board.numOfMines=parseInt(e.target.value),"underway"==s.state?t.modals.settings.boardApplyWarning.style.display="block":s.board.numOfMines=parseInt(e.target.value)})),t.modals.settings.customBoard.numOfMines.addEventListener("blur",(e=>{(e.target.value<2||!e.target.value)&&(e.target.value=2),r.board.numOfMines=parseInt(e.target.value),"underway"==s.state?t.modals.settings.boardApplyWarning.style.display="block":s.board.numOfMines=parseInt(e.target.value)})),t.modals.statistics.select.addEventListener("change",(e=>{b(e.target.value)})),t.modals.settings.boardSize.addEventListener("change",(e=>{t.modals.settings.customBoard.container.style.height=`${t.modals.settings.customBoard.container.scrollHeight}px`,"custom"==e.target.value?(t.modals.settings.customBoard.container.classList.add("open"),t.modals.settings.customBoard.container.addEventListener("transitionend",(()=>{t.modals.settings.customBoard.container.style.removeProperty("height")}),{once:!0})):(t.modals.settings.customBoard.container.classList.remove("open"),window.setTimeout((()=>{t.modals.settings.customBoard.container.style.removeProperty("height")})))}));const S=document.documentElement;t.modals.settings.tileSize.addEventListener("input",(e=>{r.tileSize=e.target.value,S.style.setProperty("--tile-size",`${e.target.value}px`)})),t.modals.settings.theme.addEventListener("change",(e=>{switch(r.theme=e.target.value,r.theme){case"auto":S.classList.add("auto"),S.classList.remove("dark");break;case"light":S.classList.remove("auto"),S.classList.remove("dark");break;case"dark":S.classList.add("dark"),S.classList.remove("auto")}}));let k=localStorage.getItem("sweeperofmines-settings"),M=localStorage.getItem("sweeperofmines-statistics");null!=k&&(r=JSON.parse(k),t.modals.settings.boardSize.value=r.boardSize,"custom"==r.boardSize&&t.modals.settings.customBoard.container.classList.add("open"),t.modals.settings.customBoard.columns.value=r.board.columns,t.modals.settings.customBoard.rows.value=r.board.rows,t.modals.settings.customBoard.numOfMines.value=r.board.numOfMines,t.modals.settings.customBoard.maxMines.value=r.maxMines,t.modals.settings.tileSize.value=r.tileSize,t.modals.settings.theme.value=r.theme,t.modals.settings.theme.dispatchEvent(new Event("change")),S.style.setProperty("--tile-size",`${r.tileSize}px`)),null!=M&&(l=JSON.parse(M));const h=new URLSearchParams(window.location.search);let z=!1;h.has("customBoardUnlimited")&&(bulkUnlimited=!0);function B(e,t){const a=e.value,n=e.min?e.min:0,s=e.max?e.max:100,r=Number(100*(a-n)/(s-n));t.innerHTML=a,t.style.left=`calc(${r}% + (${10-.19*r}px))`}document.querySelectorAll(".range-wrap").forEach((e=>{const t=e.querySelector('[type="range"]'),a=e.querySelector(".bubble");t.addEventListener("input",(()=>{B(t,a)})),B(t,a)}));let O=0,E=e("xyzzypixel");function T(){t.playarea.board.tiles.forEach((e=>{e.addEventListener("pointerover",(()=>{s.xyzzyShift&&(a[e.dataset.row][e.dataset.column].hasMine?E.style.backgroundColor="#000":E.style.backgroundColor="#FFF")}))}))}document.onkeydown=e=>{e.key=="xyzzy"[O]?O++:O=0,O>=5&&(T(),s.xyzzyActivated=!0,document.onkeydown=e=>{"Shift"==e.key&&(s.xyzzyShift=!0)},document.onkeyup=e=>{"Shift"==e.key&&(s.xyzzyShift=!1)})},L()}();